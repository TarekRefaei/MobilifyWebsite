{"version":3,"file":"next-sanity.esm.js","sources":["../src/client.ts","../src/aborter.ts","../src/currentUser.ts","../src/useSubscription.ts"],"sourcesContent":["import type {ClientConfig, SanityClient} from '@sanity/client'\nimport sanityClient from '@sanity/client'\n\nexport function createClient(config: ClientConfig): SanityClient {\n  return sanityClient(config)\n}\n","export interface Aborter {\n  abort(): void\n  signal: AbortSignal\n}\n\nclass MockAbortController {\n  _signal = {aborted: false}\n  get signal() {\n    return this._signal as AbortSignal\n  }\n  abort() {\n    this._signal.aborted = true\n  }\n}\n\nexport function getAborter(): Aborter {\n  return typeof AbortController === 'undefined'\n    ? new MockAbortController()\n    : new AbortController()\n}\n","import {useEffect, useState} from 'react'\n\nimport {Aborter, getAborter} from './aborter'\nimport {CurrentUser} from './types'\n\nexport function createCurrentUserHook({projectId}: {projectId: string; dataset?: string}) {\n  // eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\n  return () => useCurrentUser(projectId)\n}\n\nexport function getCurrentUser(\n  projectId: string,\n  abort: Aborter,\n  token?: string\n): Promise<CurrentUser | null> {\n  const headers = token ? {Authorization: `Bearer ${token}`} : undefined\n  return fetch(`https://${projectId}.api.sanity.io/v1/users/me`, {\n    credentials: 'include',\n    signal: abort.signal,\n    headers,\n  })\n    .then((res) => res.json())\n    .then((res) => (res?.id ? res : null))\n}\n\nfunction useCurrentUser(projectId: string) {\n  const [data, setUser] = useState<CurrentUser | null>()\n  const [error, setError] = useState<Error>()\n\n  useEffect(() => {\n    const aborter = getAborter()\n    getCurrentUser(projectId, aborter)\n      .then(setUser)\n      .catch((err: Error) => err.name !== 'AbortError' && setError(err))\n\n    return () => {\n      aborter.abort()\n    }\n  }, [projectId])\n\n  return {data, error, loading: data !== null || !error}\n}\n","import {GroqStore, Subscription} from '@sanity/groq-store'\nimport {useEffect, useMemo, useState} from 'react'\n\nimport {Aborter, getAborter} from './aborter'\nimport {getCurrentUser} from './currentUser'\nimport {ProjectConfig} from './types'\n\nconst EMPTY_PARAMS = {}\n\nexport type Params = Record<string, unknown>\nexport interface SubscriptionOptions<R = any> {\n  enabled?: boolean\n  params?: Params\n  initialData?: R\n}\n\n// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\nexport function createPreviewSubscriptionHook({\n  projectId,\n  dataset,\n  token,\n  EventSource,\n  documentLimit = 3000,\n}: ProjectConfig & {documentLimit?: number}) {\n  // Only construct/setup the store when `getStore()` is called\n  let store: Promise<GroqStore>\n\n  return function usePreviewSubscription<R = any>(\n    query: string,\n    options: SubscriptionOptions<R> = {}\n  ) {\n    const {params = EMPTY_PARAMS, initialData, enabled} = options\n    return useQuerySubscription<R>({\n      getStore,\n      projectId,\n      query,\n      params,\n      initialData: initialData as any,\n      enabled: enabled ? typeof window !== 'undefined' : false,\n      token,\n    })\n  }\n\n  function getStore(abort: Aborter) {\n    if (!store) {\n      store = import('@sanity/groq-store').then(({groqStore}) => {\n        // Skip creating the groq store if we've been unmounted to save memory and reduce gc pressure\n        if (abort.signal.aborted) {\n          const error = new Error('Cancelling groq store creation')\n          // This ensures we can skip it in the catch block same way\n          error.name = 'AbortError'\n          return Promise.reject(error)\n        }\n\n        return groqStore({\n          projectId,\n          dataset,\n          documentLimit,\n          token,\n          EventSource,\n          listen: true,\n          overlayDrafts: true,\n          subscriptionThrottleMs: 10,\n        })\n      })\n    }\n    return store\n  }\n}\n\nfunction useQuerySubscription<R = any>(options: {\n  getStore: (abort: Aborter) => Promise<GroqStore>\n  projectId: string\n  query: string\n  params: Params\n  initialData: R\n  enabled: boolean\n  token?: string\n}) {\n  const {getStore, projectId, query, initialData, enabled = false, token} = options\n  const [error, setError] = useState<Error>()\n  const [loading, setLoading] = useState(false)\n  const [data, setData] = useState<R>()\n  const params = useParams(options.params)\n\n  // Use \"deep\" dependency comparison because params are often not _referentially_ equal,\n  // but contains the same shallow properties, eg `{\"slug\": \"some-slug\"}`\n  useEffect(() => {\n    if (!enabled) {\n      return\n    }\n\n    setLoading(true)\n\n    const aborter = getAborter()\n    let subscription: Subscription | undefined\n    getCurrentUser(projectId, aborter, token)\n      .then((user) => {\n        if (user) {\n          return\n        }\n\n        // eslint-disable-next-line no-console\n        console.warn('Not authenticated - preview not available')\n        throw new Error('Not authenticated - preview not available')\n      })\n      .then(() => getStore(aborter))\n      .then((store) => {\n        subscription = store.subscribe(query, params, (err, result) => {\n          if (err) {\n            setError(err)\n          } else {\n            setData(result)\n          }\n        })\n      })\n      .catch((err: Error) => (err.name === 'AbortError' ? null : setError(err)))\n      .finally(() => setLoading(false))\n\n    // eslint-disable-next-line consistent-return\n    return () => {\n      if (subscription) {\n        subscription.unsubscribe()\n      }\n\n      aborter.abort()\n    }\n  }, [getStore, query, params, enabled, projectId, token])\n\n  return {\n    data: typeof data === 'undefined' ? initialData : data,\n    loading,\n    error,\n  }\n}\n\n// Return params that are stable with deep equal as long as the key order is the same\nfunction useParams(params: Params): Params {\n  const stringifiedParams = useMemo(() => JSON.stringify(params), [params])\n  return useMemo(() => JSON.parse(stringifiedParams), [stringifiedParams])\n}\n"],"names":["createClient","config","sanityClient","MockAbortController","aborted","abort","_signal","getAborter","AbortController","createCurrentUserHook","projectId","useCurrentUser","getCurrentUser","token","headers","Authorization","undefined","fetch","credentials","signal","then","res","json","id","useState","data","setUser","error","setError","useEffect","aborter","catch","err","name","loading","EMPTY_PARAMS","createPreviewSubscriptionHook","dataset","EventSource","documentLimit","store","usePreviewSubscription","query","options","params","initialData","enabled","useQuerySubscription","getStore","window","groqStore","Error","Promise","reject","listen","overlayDrafts","subscriptionThrottleMs","setLoading","setData","useParams","subscription","user","console","warn","subscribe","result","finally","unsubscribe","stringifiedParams","useMemo","JSON","stringify","parse"],"mappings":"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"}